# https://taskfile.dev

version: '3'

env:
  OUTPUT_FILE: userscript.user.js
  TEMP_FOLDER: .temp
  DIST_FOLDER: dist

tasks:
  build:
    deps: [delete-temp]
    cmds:
      # Transpile TypeScript files into JavaScript
      - echo ðŸ’¬ Transpiling TypeScript files...
      - tsc

      # Bundle all file in one JavaScript file
      - echo ðŸ“¦ Bundling files...
      - npx rollup $TEMP_FOLDER/main.js --file $TEMP_FOLDER/main.js --format iife

      # Add meta to the userscript file
      - echo ðŸ—ƒï¸ Adding metadata to the userscript file...
      - mkdir $DIST_FOLDER
      - touch $DIST_FOLDER/$OUTPUT_FILE
      - cat userscript.meta.js $TEMP_FOLDER/main.js > $DIST_FOLDER/$OUTPUT_FILE

      # Delete temporary files
      - echo ðŸ§¹ Cleaning temporary files...
      - rm -fr $TEMP_FOLDER

      # Format the final code
      - echo âœ¨ Formatting the final code...
      - npm run --silent format

      - echo ðŸŽ‰ The userscript has been built! ðŸŽ‰
      - echo
      - echo ðŸ‘‰ Your userscript is ready at $DIST_FOLDER/$OUTPUT_FILE
    silent: true

  delete-temp:
    cmds:
      - rm -fr $TEMP_FOLDER $DIST_FOLDER
